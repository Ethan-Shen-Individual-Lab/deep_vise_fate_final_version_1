<!DOCTYPE html>
<html lang="zh">
<head>
    <title>联邦学习预测性维护系统</title>
    <link rel="stylesheet" href="top-bar.css">
    <script src="top-bar.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .title {
            font-size: 36px;             /* Large font size */
            font-weight: bold;           /* Make the title bold */
            color: #000000;              /* Dark grey color for readability */
            text-align: center;          /* Center the title */
            margin-top: -50px;            /* Add space above the title */
            margin-bottom: 20px;         /* Add space below the title */
            font-family: 'Arial', sans-serif; /* Clean and modern font */
            text-transform: uppercase;   /* Make the title uppercase */
            letter-spacing: 2px;         /* Add letter spacing for a more spacious look */
            border-bottom: 3px solid #8f3487; /* Add a decorative underline */
            padding-bottom: 10px;        /* Add padding below the title */
        }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
        }
        a.return-link {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 0.8em;
            text-decoration: none;
            z-index: 24;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 22px;
        }
        .real-header{
            background: #fff;
            margin-top: 0px;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            color:#1a73e8;
        }
        .header h1 {
            color: #1a73e8;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .section {
            background: #fff;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #1a73e8;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8f0fe;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background: #fff;
            border-radius: 8px;
            padding: 15px;
        }

        .parameter-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .parameter-item {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e8f0fe;
            transition: all 0.3s ease;
        }

        .parameter-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .parameter-item h3 {
            color: #1a73e8;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .parameter-item p {
            margin: 10px 0;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .privacy-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 15px;
        }

        .privacy-control {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .privacy-control h3 {
            color: #1a73e8;
            margin-bottom: 15px;
            font-size: 16px;
        }

        input[type="range"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }

        select {
            background: #fff;
            height: 36px;
        }

        #training-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        #training-status .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            color: #333;
            font-size: 14px;
        }

        .status-value {
            color: #1a73e8;
            font-weight: bold;
            font-size: 14px;
        }

        .data-source-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .selector-title {
            color: #1a73e8;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .selector-options {
            display: flex;
            gap: 20px;
        }

        .option-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: #fff;
            border: 2px solid #e8f0fe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #1a73e8;
            transform: translateY(-2px);
        }

        .option-item input[type="radio"] {
            display: none;
        }

        .option-item input[type="radio"]:checked + .option-text {
            color: #1a73e8;
            font-weight: bold;
        }

        .option-item input[type="radio"]:checked ~ .option-description {
            color: #1a73e8;
        }

        .option-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .option-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* 中状态的样式 */
        .option-item input[type="radio"]:checked + .option-text::before {
            content: "✓";
            margin-right: 8px;
            color: #1a73e8;
        }

        .option-item input[type="radio"]:checked {
            background: #e8f0fe;
            border-color: #1a73e8;
        }

        .create-project-btn {
            margin-top: 20px;
            text-align: center;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .model-config {
            margin-top: 20px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .config-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .config-item h3 {
            color: #1a73e8;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }
        
        .config-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }

        .form-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            margin: 20px 0;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .feature-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .feature-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #333;
            font-size: 14px;
        }

        .feature-select option {
            padding: 8px;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #f0f2f5;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #1a73e8;
            transition: width 0.5s ease;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1a73e8;
        }

        .history-item .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #1a73e8;
            font-weight: bold;
        }

        .history-item .history-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .history-item .history-detail {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-item .history-detail .label {
            color: #666;
            min-width: 80px;
            font-size: 14px;
        }

        .history-item .history-detail .value {
            color: #1a73e8;
            font-weight: 500;
            font-size: 14px;
            flex-grow: 1;
        }

        .no-history {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            color: #fff;
        }

        .dropdown-checkbox {
            position: relative;
            width: 100%;
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
        }

        .dropdown-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .dropdown-arrow {
            transition: transform 0.3s ease;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 40, 60, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dropdown-content.show {
            display: block;
        }

        .checkbox-item {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-item label {
            color: #fff;
            cursor: pointer;
            user-select: none;
            flex: 1;
        }

        .feature-select-wrapper {
            position: relative;
            width: 100%;
        }

        .feature-select[multiple] {
            height: 200px;
            padding: 8px;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            color: #333;
            overflow-y: auto;
        }

        .feature-select[multiple] option {
            padding: 8px;
            background-color: #fff;
            color: #333;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            /* 移除默认的选择样式 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* 使用伪元素来创建自定义的选中效果 */
        .feature-select[multiple] option:checked {
            background-color: #f0f0f0 !important;
            color: #333;
        }

        .feature-select[multiple] option:hover {
            background-color: #f5f5f5;
        }
        .nav-buttons {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 3;
        }
        .nav-button {
            background-color: transparent;
            color: rgb(0, 0, 0);
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.65);
        }
        .nav-button-special{
            background-color: rgba(255, 255, 255, 0.65);
            color: rgb(0, 0, 0);
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* 添加自定义的多选行为样式 */
        .feature-select[multiple]:focus option:checked {
            background-color: #f0f0f0 !important;
            color: #333;
        }
        .logo {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 24;
        }
        .logo img {
            width: 100px; /* 调整图标大小 */
            height: auto;
        }
        .video-background {
            position: relative;
            top: -10vh;
            left: 0;
            width: 100%;
            height: 79vh;
            object-fit: cover;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="nav-buttons">
            <div>
                <button class="nav-button" onclick="window.location.href='intro.html'" onmouseover="expandTopBar(this)">首页</button>
                <div class="sub-menu">
                    <a href="intro.html">子菜单1</a>
                    <a href="intro.html">子菜单2</a>
                </div>
            </div>
            <div>
                <button class="nav-button" onclick="window.location.href='health_monitor.html'" onmouseover="expandTopBar(this)">采集与监控</button>
                <div class="sub-menu">
                    <a href="health_monitor.html">子菜单1</a>
                    <a href="health_monitor.html">子菜单2</a>
                </div>
            </div>
            
            <div>
                <button class="nav-button" onclick="window.location.href='federal_learning.html'" onmouseover="expandTopBar(this)">联邦学习</button>
                <div class="sub-menu">
                    <a href="production_scheduling.html">子菜单1</a>
                    <a href="production_scheduling.html">子菜单2</a>
                </div>
            </div>
            <div>
                <button class="nav-button" onclick="window.location.href='quality_control_defect_prediction.html'" onmouseover="expandTopBar(this)">双向金融</button>
                <div class="sub-menu">
                    <a href="quality_control_defect_prediction.html">子菜单1</a>
                    <a href="quality_control_defect_prediction.html">子菜单2</a>
                </div>
            </div>
            <div>
                <button class="nav-button" onclick="window.location.href='maintenance_optimization.html'" onmouseover="expandTopBar(this)">可视化</button>
                <div class="sub-menu">
                    <a href="maintenance_optimization.html">子菜单1</a>
                    <a href="maintenance_optimization.html">子菜单2</a>
                </div>
            </div>
            <div>
                <button class="nav-button" onclick="window.location.href='privacy_security_management.html'" onmouseover="expandTopBar(this)">数据安全</button>
                <div class="sub-menu">
                    <a href="privacy_security_management.html">子菜单1</a>
                    <a href="privacy_security_management.html">子菜单2</a>
                </div>
            </div>
        </div>
    </div>
    <video class="video-background" id="video_mp4" autoplay muted loop>
        <source src="figures/14.mp4" type="video/mp4">
        您的浏览器不支持视频标签。
    </video>
    <div class="logo">
        <img src="figures/7.png" alt="Logo">
    </div>
    <a href="index.html" class="return-link">返回</a>  
    <div class="title">
        联邦学习模型与风险评估
    </div>
    <div class="container">
        <!-- 设备参数监测区域 -->
        <div class="section">
            <h2>压力机损坏预警系统</h2>
            
            <!-- 数据源选择 -->
            <div class="data-source-selector">
                <div class="selector-title">数据源选择</div>
                <div class="selector-options">
                    <label class="option-item">
                        <input type="radio" name="data-source" value="local" checked>
                        <span class="option-text">仅使用本地数据</span>
                        <span class="option-description">仅使用当前工厂采集的设备运行数据进行分析</span>
                    </label>
                    <label class="option-item">
                        <input type="radio" name="data-source" value="federated">
                        <span class="option-text">导入联邦数据</span>
                        <span class="option-description">结合其他工厂的设备数据进行联合分析</span>
                    </label>
                </div>
                <!-- 添加确定按钮 -->
                <div class="create-project-btn">
                    <button id="create-project" class="btn-primary">确定新建学习项目</button>
                </div>
            </div>

            <div class="parameter-list">
                <div class="parameter-item">
                    <h3>本地模型状态</h3>
                    <p>本地节点数: <span id="local-node-count">--</span></p>
                    <p>本地数据量: <span id="local-data-count">--</span></p>
                    <p>上次更新: <span id="local-last-update">2024-01-01</span></p>
                </div>
                <div class="parameter-item">
                    <h3>联邦模型状态</h3>
                    <p>外部节点数: <span id="guest-nodes">--</span></p>
                    <p>外部数据量: <span id="guest-data-count">--</span></p>
                    <p>聚合状态: <span id="fed-status">正常</span></p>
                </div>
                <div class="parameter-item">
                    <h3>模型性能指标</h3>
                    <p>预测准确率: <span id="model-accuracy">95%</span></p>
                    <p>召回率: <span id="model-recall">92%</span></p>
                    <p>F1分数: <span id="model-f1">93%</span></p>
                </div>
            </div>
        </div>

        <!-- 其他所有功能区域，初始隐藏 -->
        <div id="additional-sections" style="display: none;">
            <!-- 特征选择区域 -->
            <div class="section">
                <h2>特征选择</h2>
                <div class="feature-selection">
                    <div class="form-group">
                        <label>选择标签变量</label>
                        <select id="label-feature" class="feature-select">
                            <option value="" disabled selected>请选择标签变量</option>
                            <!-- 选项将通过API动态加载 -->
                        </select>
                        <small class="form-text">选择要预测的目标变量</small>
                    </div>
                    
                    <!-- 修改特征选择区域的样式 -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label>选择自变量（可多选）</label>
                        <div class="feature-select-wrapper">
                            <select id="independent-features" class="feature-select" multiple size="8">
                                <option value="" disabled>请选择自变量</option>
                                <!-- 选项将通过API动态加载 -->
                            </select>
                        </div>
                        <small class="form-text">点击可直接选择多个自变量</small>
                    </div>
                </div>
            </div>

            <!-- 原有的模型配置区域 -->
            <div class="model-config">
                <div class="section">
                    <h2>模型配置</h2>
                    <div class="config-grid">
                        <div class="config-item">
                            <h3>节点配置</h3>
                            <div class="form-group">
                                <label>使用外部节点数</label>
                                <input type="number" id="node-count" min="1" max="3" value="3">
                                <small class="form-text">最大可选择的外部节点数为: <span id="max-nodes">3</span></small>
                            </div>
                            <div class="form-group">
                                <label>最小数据量要求</label>
                                <input type="number" id="min-data" min="100" value="1000">
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <h3>训练参数</h3>
                            <div class="form-group">
                                <label>训练轮次</label>
                                <input type="number" id="epochs" min="1" value="10">
                            </div>
                            <div class="form-group">
                                <label>学习率</label>
                                <input type="number" id="learning-rate" min="0.0001" max="1" step="0.0001" value="0.001">
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <h3>模型架构</h3>
                            <div class="form-group">
                                <label>模型选择</label>
                                <select id="model-type">
                                    <option value="lstm">LSTM</option>
                                    <option value="cnn">CNN</option>
                                    <option value="mlp">MLP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>隐藏层数量</label>
                                <input type="number" id="hidden-layers" min="1" value="3">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 差分隐私设置 -->
            <div class="section">
                <h2>差分隐私配置</h2>
                <div class="privacy-settings">
                    <div class="privacy-control">
                        <h3>隐私预算(ε)</h3>
                        <input type="range" id="privacy-budget" min="0.1" max="10" step="0.1">
                        <span id="privacy-budget-value">1.0</span>
                    </div>
                    <div class="privacy-control">
                        <h3>噪声机制</h3>
                        <select id="noise-mechanism">
                            <option value="laplace">拉普拉斯噪声</option>
                            <option value="gaussian">高斯��声</option>
                        </select>
                    </div>
                    <div class="privacy-control">
                        <h3>数据灵敏度</h3>
                        <input type="number" id="data-sensitivity" min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- 添加新的按钮区域 -->
            <div class="section action-buttons">
                <button class="btn-primary" id="start-training" disabled>开始训练</button>
                <button class="btn-secondary" id="cancel-config">取消</button>
            </div>

            <!-- 模型训练状态 -->
            <div class="section">
                <h2>模型训练状态</h2>
                <div id="training-status">
                    <div class="status-item">
                        <span class="status-label">训练任务ID:</span>
                        <span class="status-value" id="taskId">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">当前任务执行时间:</span>
                        <span class="status-value" id="elapsedTime">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">任务状态:</span>
                        <span class="status-value" id="status">等待中</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="training-progress" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <!-- 训练历史功能栏 -->
            <div class="section">
                <h2>训练历史</h2>
                <div id="training-history">
                    <!-- 训练史记录将在这里动态添加 -->
                </div>
            </div>
        </div>
    </div>
    <div class="to-llm" onclick="window.location.href='LLM.html'">
        <span class="to-llm-text">智能管家</span>
    </div>
    <script>
        // 添加一个全局变量来跟踪任务ID
        let currentTaskId = 0;

        // 监听隐私设置变化
        document.getElementById('privacy-budget').addEventListener('input', function(e) {
            document.getElementById('privacy-budget-value').textContent = e.target.value;
        });

        // 修改页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取初始数据
            fetchHostStatus();  // 获取本地数据状态
            fetchGuestNodesCount();  // 获取外部节点数据
            
            // 获取初始数据源选择
            const initialDataSource = document.querySelector('input[name="data-source"]:checked').value;
            updateParameterDisplay(initialDataSource);
        });

        // 修改获取本地数据状态的函数
        async function fetchHostStatus() {
            try {
                const response = await fetch('/api/host-status');
                const data = await response.json();
                // 直接显示数值，不使用占位符
                document.getElementById('local-node-count').textContent = `${data.node_counts}个`;
                document.getElementById('local-data-count').textContent = `${data.data_counts}条`;
            } catch (error) {
                console.error('获取本地数据状态失败:', error);
                document.getElementById('local-node-count').textContent = '获取失败';
                document.getElementById('local-data-count').textContent = '获取失败';
            }
        }

        // 修改获取外部节点数的函数
        async function fetchGuestNodesCount() {
            try {
                const response = await fetch('/api/guest-nodes-count');
                const data = await response.json();
                // 直接显示数值，不使用占位符
                document.getElementById('guest-nodes').textContent = `${data.count}个`;
                document.getElementById('guest-data-count').textContent = `${data.data_counts}条`;
            } catch (error) {
                console.error('获取外部节点数据失败:', error);
                document.getElementById('guest-nodes').textContent = '获取失败';
                document.getElementById('guest-data-count').textContent = '获取失败';
            }
        }

        // 修改数据源选择的处理函数
        function updateParameterDisplay(dataSource) {
            // 始终获取本地数据状态
            fetchHostStatus();
            // 始终获外部节点数
            fetchGuestNodesCount();
        }

        // 监听数据源选择���化
        document.querySelectorAll('input[name="data-source"]').forEach(radio => {
            radio.addEventListener('change', function(e) {
                updateParameterDisplay(e.target.value);
            });
        });

        // 修改获取特征列表的函数
        async function fetchFeatures() {
            try {
                const response = await fetch('/api/features');
                const data = await response.json();
                const labelSelect = document.getElementById('label-feature');
                const independentSelect = document.getElementById('independent-features');
                
                // 清空现有选项
                labelSelect.innerHTML = '<option value="" disabled selected>请选择标签变量</option>';
                independentSelect.innerHTML = '<option value="" disabled>请选择自变量</option>';
                
                if (data.success && data.features) {
                    // 添加特征选项
                    data.features.forEach(feature => {
                        // 为标签变量添加选项
                        const labelOption = document.createElement('option');
                        labelOption.value = feature;
                        labelOption.textContent = feature;
                        labelSelect.appendChild(labelOption);
                        
                        // 为自变量添加选项
                        const independentOption = document.createElement('option');
                        independentOption.value = feature;
                        independentOption.textContent = feature;
                        // 设置选项的属性以支持多选
                        independentOption.setAttribute('role', 'option');
                        independentOption.setAttribute('aria-selected', 'false');
                        independentSelect.appendChild(independentOption);
                    });

                    // 添加多选支持
                    independentSelect.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        
                        const option = e.target;
                        if (option.tagName === 'OPTION' && !option.disabled) {
                            option.selected = !option.selected;  // 切换选中状态
                            
                            // 触发change事件
                            const event = new Event('change');
                            this.dispatchEvent(event);
                        }
                    });
                }
            } catch (error) {
                console.error('获取特征列表失败:', error);
            }
        }

        // 修改创建项目按钮的点击事件处理函数
        document.getElementById('create-project').addEventListener('click', async function() {
            const selectedDataSource = document.querySelector('input[name="data-source"]:checked').value;
            
            if (confirm(`确定要使用${selectedDataSource === 'local' ? '本地数据' : '联邦数据'}创建新的学习项目吗？`)) {
                // 如果选择了联邦数据，则连接FATE
                if (selectedDataSource === 'federated') {
                    try {
                        // 显示连接状态
                        const statusDiv = document.createElement('div');
                        statusDiv.style.color = '#fff';
                        statusDiv.style.marginTop = '10px';
                        statusDiv.textContent = '正在连接FATE服务器...';
                        this.parentNode.appendChild(statusDiv);

                        // 调用后端API连接FATE
                        const response = await fetch('/api/connect_fate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                mode: 'federated'
                            })
                        });

                        if (!response.ok) {
                            throw new Error('连接FATE失败');
                        }

                        const data = await response.json();
                        
                        // 更新连接状态
                        statusDiv.textContent = '已成功连接FATE服务器';
                        statusDiv.style.color = '#00ff00';

                        // 延迟一秒后显示其他配置选项
                        setTimeout(() => {
                            document.getElementById('additional-sections').style.display = 'block';
                            this.disabled = true;
                            fetchFeatures();
                        }, 1000);

                    } catch (error) {
                        console.error('连接FATE出错:', error);
                        alert('连接FATE服务器失败，请检查网络连接后重试');
                        return;
                    }
                } else {
                    // 如果是本地数据，直接显示配置选项
                    document.getElementById('additional-sections').style.display = 'block';
                    this.disabled = true;
                    fetchFeatures();
                }
                
                // 根据数据源类型显示/隐藏节点配置
                const nodeConfigItem = document.querySelector('.config-item:first-child');
                nodeConfigItem.style.display = selectedDataSource === 'federated' ? 'block' : 'none';
            }
        });

        // 修改验证函数，包含自变量的验证
        function validateInputs() {
            const labelFeature = document.getElementById('label-feature').value;
            const independentFeatures = Array.from(
                document.getElementById('independent-features').selectedOptions
            ).map(option => option.value);
            
            // 获取所有必填字段
            const nodeCount = document.getElementById('node-count').value;
            const minData = document.getElementById('min-data').value;
            const epochs = document.getElementById('epochs').value;
            const learningRate = document.getElementById('learning-rate').value;
            const modelType = document.getElementById('model-type').value;
            const hiddenLayers = document.getElementById('hidden-layers').value;
            const privacyBudget = document.getElementById('privacy-budget').value;
            const noiseMechanism = document.getElementById('noise-mechanism').value;
            const dataSensitivity = document.getElementById('data-sensitivity').value;

            // 检查是否至少选择了一个自变量
            const isValid = labelFeature && independentFeatures.length > 0 && nodeCount && minData && epochs && 
                           learningRate && modelType && hiddenLayers && 
                           privacyBudget && noiseMechanism && dataSensitivity;

            // 启用或禁用开始训练按钮
            document.getElementById('start-training').disabled = !isValid;
        }

        // 为所有输入字段添加验证监听
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', validateInputs);
            element.addEventListener('input', validateInputs);
        });

        // 在页面加载时进行始验证
        document.addEventListener('DOMContentLoaded', validateInputs);

        // 为特征选择添加验证监听
        document.getElementById('label-feature').addEventListener('change', validateInputs);

        // 为自变量选择添加验证监听
        document.getElementById('independent-features').addEventListener('change', validateInputs);

        // 修改取消按钮的处理函数
        document.getElementById('cancel-config').addEventListener('click', function() {
            document.getElementById('additional-sections').style.display = 'none';
            document.getElementById('create-project').disabled = false;
            
            // 重置特征选择
            document.getElementById('label-feature').selectedIndex = 0;
            
            // 重置自变量选择
            const independentSelect = document.getElementById('independent-features');
            Array.from(independentSelect.options).forEach(option => {
                option.selected = false;
            });
            
            // 清空所有输入字段的值
            document.querySelectorAll('input, select').forEach(element => {
                if (element.type === 'number' || element.type === 'select-one') {
                    element.value = element.defaultValue;
                } else if (element.type === 'range') {
                    element.value = 1.0;
                    document.getElementById('privacy-budget-value').textContent = '1.0';
                }
            });
            
            // 重置训练状态
            document.getElementById('taskId').textContent = '0';
            document.getElementById('elapsedTime').textContent = '--';
            document.getElementById('status').textContent = '等待中';
            
            // 重置进度条
            document.getElementById('training-progress').style.width = '0%';
            
            // 移除预警结果（如果存在）
            const warningResults = document.querySelectorAll('#training-status .status-item');
            if (warningResults.length > 3) { // 原本有3个status-item
                warningResults[3].remove();
            }
            
            // 可选：是否要清除训练历史
            if (confirm('是否同时清除训练历史记录？')) {
                document.getElementById('training-history').innerHTML = `
                    <div class="no-history">暂无训练历史记录</div>
                `;
            }
            
            // 重置任务ID（可选）
            if (confirm('是否重置任务ID？')) {
                currentTaskId = 0;
            }
            
            // 重置所有复选框
            document.querySelectorAll('#independent-features input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        });

        // 修改开始训练的处理函数
        document.getElementById('start-training').addEventListener('click', async function() {
            try {
                // 增加任务ID
                currentTaskId++;
                const taskId = currentTaskId;
                
                let elapsedTime = 0;
                let progress = 0;
                
                // 生成随机执行时间（8-23秒）
                const totalExecutionTime = Math.floor(Math.random() * (23 - 8 + 1)) + 8;
                
                // 更新初始状态
                document.getElementById('taskId').textContent = taskId;
                document.getElementById('elapsedTime').textContent = '0 秒';
                document.getElementById('status').textContent = '执行中';
                document.getElementById('training-progress').style.width = '0%';
                
                // 调用后端API启动联邦学习
                fetch('/api/run_federal_learning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        // 可以添加其他需要的参数
                    })
                });
                
                // 创建定时器，每秒更新时间和进度
                const timer = setInterval(() => {
                    elapsedTime++;
                    progress = (elapsedTime / totalExecutionTime) * 100; // 使用随机生成的总时间
                    
                    // 更新显示
                    document.getElementById('elapsedTime').textContent = `${elapsedTime} 秒`;
                    document.getElementById('training-progress').style.width = `${progress}%`;
                    
                    // 检查是否完成
                    if (elapsedTime >= totalExecutionTime) {
                        clearInterval(timer);
                        document.getElementById('status').textContent = '已完成';
                        document.getElementById('training-progress').style.width = '100%';
                        
                        // 添加预警结果
                        const warningResult = document.createElement('div');
                        warningResult.className = 'status-item';
                        warningResult.innerHTML = `
                            <span class="status-label">损毁预警机器ID：</span>
                            <span class="status-value">无</span>
                        `;
                        document.getElementById('training-status').appendChild(warningResult);
                        
                        // 添加训练历史记录
                        addTrainingHistory({
                            taskId: taskId,
                            startTime: new Date().toLocaleString(),
                            duration: `${elapsedTime}秒`,
                            dataSource: document.querySelector('input[name="data-source"]:checked').value === 'local' ? '本地数据' : '联邦数据',
                            modelType: document.getElementById('model-type').value,
                            status: '已完成',
                            warningResult: '无'
                        });
                    }
                }, 1000);
                
            } catch (error) {
                console.error('训练过程出错:', error);
                document.getElementById('status').textContent = '执行出错';
            }
        });

        function validateInputs() {
            // 获取所有必填字段
            const nodeCount = document.getElementById('node-count').value;
            const minData = document.getElementById('min-data').value;
            const epochs = document.getElementById('epochs').value;
            const learningRate = document.getElementById('learning-rate').value;
            const modelType = document.getElementById('model-type').value;
            const hiddenLayers = document.getElementById('hidden-layers').value;
            const privacyBudget = document.getElementById('privacy-budget').value;
            const noiseMechanism = document.getElementById('noise-mechanism').value;
            const dataSensitivity = document.getElementById('data-sensitivity').value;

            // 检查所有字段是否都已填写
            const isValid = nodeCount && minData && epochs && learningRate && 
                           modelType && hiddenLayers && privacyBudget && 
                           noiseMechanism && dataSensitivity;

            // 启用或禁用开始训练按钮
            document.getElementById('start-training').disabled = !isValid;
        }

        // 为所有输入字段添加验证监听
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', validateInputs);
            element.addEventListener('input', validateInputs);
        });

        // 在页面加载时进行初始验证
        document.addEventListener('DOMContentLoaded', validateInputs);

        // 添加训练历史记录的函数
        function addTrainingHistory(historyData) {
            const historyContainer = document.getElementById('training-history');
            
            // 创建历史记录项
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            historyItem.innerHTML = `
                <div class="history-header">
                    <span>任务ID: ${historyData.taskId}</span>
                    <span>${historyData.startTime}</span>
                </div>
                <div class="history-content">
                    <div class="history-detail">
                        <span class="label">执行时长</span>
                        <span class="value">${historyData.duration}</span>
                    </div>
                    <div class="history-detail">
                        <span class="label">数据源</span>
                        <span class="value">${historyData.dataSource}</span>
                    </div>
                    <div class="history-detail">
                        <span class="label">模型类型</span>
                        <span class="value">${historyData.modelType}</span>
                    </div>
                    <div class="history-detail">
                        <span class="label">执行状态</span>
                        <span class="value">${historyData.status}</span>
                    </div>
                    <div class="history-detail">
                        <span class="label">预警结果</span>
                        <span class="value">${historyData.warningResult}</span>
                    </div>
                </div>
            `;
            
            // 将新的历史记录添加到容器的开头
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
        }

        // 添加切换下拉框显示的函数
        function toggleDropdown() {
            const dropdownContent = document.getElementById('independent-features');
            const arrow = document.querySelector('.dropdown-arrow');
            dropdownContent.classList.toggle('show');
            arrow.style.transform = dropdownContent.classList.contains('show') ? 'rotate(180deg)' : '';
        }

        // 添加更新已选择特征文本的函数
        function updateSelectedFeaturesText() {
            const selectedFeatures = Array.from(
                document.querySelectorAll('#independent-features input[type="checkbox"]:checked')
            ).map(checkbox => checkbox.value);
            
            const selectedText = document.getElementById('selected-features-text');
            if (selectedFeatures.length === 0) {
                selectedText.textContent = '请选择自变量';
            } else {
                selectedText.textContent = `已选择 ${selectedFeatures.length} 个变量`;
            }
        }

        // 添加点击外部关闭下拉框的处理
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.dropdown-checkbox');
            const dropdownContent = document.getElementById('independent-features');
            
            if (!dropdown.contains(e.target) && dropdownContent.classList.contains('show')) {
                dropdownContent.classList.remove('show');
                document.querySelector('.dropdown-arrow').style.transform = '';
            }
        });
    </script>
</body>
</html>
